<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><meta name="baidu-site-verification" content="code-KCMz4b3cnd"><meta name="google-site-verification" content="MTp8U7dJ1uzrfz8Mu6rgqX1CIm3HjqPWd0xaRcv1tFg"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/favicon.png" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"aisakaaoi.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:"valine",storage:!0,lazyload:!1,nav:null,activeClass:"valine"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="ç®€ä»‹åœ¨å­¦ä¹ äº†Android éŸ³è§†é¢‘çš„åŸºæœ¬çš„ç›¸å…³çŸ¥è¯†ï¼Œå¹¶æ•´ç†äº†ç›¸å…³çš„APIä¹‹åï¼Œåº”è¯¥å¯¹åŸºæœ¬çš„éŸ³è§†é¢‘æœ‰ä¸€å®šçš„è½®å»“äº†ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªAndroidéŸ³è§†é¢‘ä¸­ç›¸å½“é‡è¦çš„å‡ ä¸ªAPIï¼šMediaCodecï¼ˆéŸ³è§†é¢‘ç¼–è§£ç ï¼‰ã€MediaExtractorï¼ˆéŸ³è§†é¢‘è§£å°è£…ï¼‰ã€MediaMuxerï¼ˆéŸ³è§†é¢‘å°è£…ï¼‰ã€‚ å­¦ä¹ è¿™ä¸ªAPIçš„æ—¶å€™ï¼Œä¸»è¦çš„æ–¹å‘ä¸ºï¼š  å­¦ä¹  MediaCodec APIï¼Œå®ŒæˆéŸ³é¢‘ AAC ç¡¬ç¼–ã€ç¡¬è§£ å­¦ä¹ "><meta property="og:type" content="article"><meta property="og:title" content="Android-éŸ³è§†é¢‘-è§†é¢‘å¼€å‘-ï¼ˆå››ï¼‰è§†é¢‘ç¼–è§£ç "><meta property="og:url" content="https://aisakaaoi.github.io/1a455a10.html"><meta property="og:site_name" content="é€¢å‚è‘µçš„ä¸ªäººåšå®¢"><meta property="og:description" content="ç®€ä»‹åœ¨å­¦ä¹ äº†Android éŸ³è§†é¢‘çš„åŸºæœ¬çš„ç›¸å…³çŸ¥è¯†ï¼Œå¹¶æ•´ç†äº†ç›¸å…³çš„APIä¹‹åï¼Œåº”è¯¥å¯¹åŸºæœ¬çš„éŸ³è§†é¢‘æœ‰ä¸€å®šçš„è½®å»“äº†ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªAndroidéŸ³è§†é¢‘ä¸­ç›¸å½“é‡è¦çš„å‡ ä¸ªAPIï¼šMediaCodecï¼ˆéŸ³è§†é¢‘ç¼–è§£ç ï¼‰ã€MediaExtractorï¼ˆéŸ³è§†é¢‘è§£å°è£…ï¼‰ã€MediaMuxerï¼ˆéŸ³è§†é¢‘å°è£…ï¼‰ã€‚ å­¦ä¹ è¿™ä¸ªAPIçš„æ—¶å€™ï¼Œä¸»è¦çš„æ–¹å‘ä¸ºï¼š  å­¦ä¹  MediaCodec APIï¼Œå®ŒæˆéŸ³é¢‘ AAC ç¡¬ç¼–ã€ç¡¬è§£ å­¦ä¹ "><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://aisakaaoi.github.io/1a455a10/1.webp"><meta property="og:image" content="https://aisakaaoi.github.io/1a455a10/2.webp"><meta property="og:image" content="https://aisakaaoi.github.io/1a455a10/3.webp"><meta property="og:image" content="https://aisakaaoi.github.io/1a455a10/4.webp"><meta property="article:published_time" content="2021-10-25T03:18:36.000Z"><meta property="article:modified_time" content="2026-01-23T11:02:39.323Z"><meta property="article:author" content="Aisaka Aoi"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://aisakaaoi.github.io/1a455a10/1.webp"><link rel="canonical" href="https://aisakaaoi.github.io/1a455a10.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>Android-éŸ³è§†é¢‘-è§†é¢‘å¼€å‘-ï¼ˆå››ï¼‰è§†é¢‘ç¼–è§£ç  | é€¢å‚è‘µçš„ä¸ªäººåšå®¢</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?7308ed05421777c301eefa3754da1b42",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="é€¢å‚è‘µçš„ä¸ªäººåšå®¢" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">aoiå­¦é™¢</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">Aisaka's Blog, School of Aoi, Aisaka University</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">20</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">1023</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><a href="https://github.com/AisakaAoi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://aisakaaoi.github.io/1a455a10.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/manatsu.jpg"><meta itemprop="name" content="Aisaka Aoi"><meta itemprop="description" content="Aisaka's Blog, School of Aoi, Aisaka University"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="é€¢å‚è‘µçš„ä¸ªäººåšå®¢"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Android-éŸ³è§†é¢‘-è§†é¢‘å¼€å‘-ï¼ˆå››ï¼‰è§†é¢‘ç¼–è§£ç </h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-10-25 11:18:36" itemprop="dateCreated datePublished" datetime="2021-10-25T11:18:36+08:00">2021-10-25</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">åˆ†ç±»äº</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%F0%9F%8C%99%E9%80%A2%E5%9D%82%E6%9D%82%E8%B0%88%E4%B8%8E%E6%90%AC%E8%BF%90/" itemprop="url" rel="index"><span itemprop="name">ğŸŒ™é€¢å‚æ‚è°ˆä¸æ¬è¿</span></a> </span>ï¼Œ <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%F0%9F%8C%99%E9%80%A2%E5%9D%82%E6%9D%82%E8%B0%88%E4%B8%8E%E6%90%AC%E8%BF%90/%E2%AD%90%E4%B8%80%E4%BA%9B%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">â­ä¸€äº›æŠ€æœ¯</span></a> </span></span><span id="/1a455a10.html" class="post-meta-item leancloud_visitors" data-flag-title="Android-éŸ³è§†é¢‘-è§†é¢‘å¼€å‘-ï¼ˆå››ï¼‰è§†é¢‘ç¼–è§£ç " title="é˜…è¯»æ¬¡æ•°"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valineï¼š</span> <a title="valine" href="/1a455a10.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/1a455a10.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="æœ¬æ–‡å­—æ•°"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span> <span>21k</span> </span><span class="post-meta-item" title="é˜…è¯»æ—¶é•¿"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span> <span>53 åˆ†é’Ÿ</span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>åœ¨å­¦ä¹ äº†Android éŸ³è§†é¢‘çš„åŸºæœ¬çš„ç›¸å…³çŸ¥è¯†ï¼Œå¹¶æ•´ç†äº†ç›¸å…³çš„APIä¹‹åï¼Œåº”è¯¥å¯¹åŸºæœ¬çš„éŸ³è§†é¢‘æœ‰ä¸€å®šçš„è½®å»“äº†ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªAndroidéŸ³è§†é¢‘ä¸­ç›¸å½“é‡è¦çš„å‡ ä¸ªAPIï¼š<strong>MediaCodec</strong>ï¼ˆéŸ³è§†é¢‘ç¼–è§£ç ï¼‰ã€<strong>MediaExtractor</strong>ï¼ˆéŸ³è§†é¢‘è§£å°è£…ï¼‰ã€<strong>MediaMuxer</strong>ï¼ˆéŸ³è§†é¢‘å°è£…ï¼‰ã€‚</p><p>å­¦ä¹ è¿™ä¸ªAPIçš„æ—¶å€™ï¼Œä¸»è¦çš„æ–¹å‘ä¸ºï¼š</p><ul><li>å­¦ä¹  MediaCodec APIï¼Œå®ŒæˆéŸ³é¢‘ AAC ç¡¬ç¼–ã€ç¡¬è§£</li><li>å­¦ä¹  MediaCodec APIï¼Œå®Œæˆè§†é¢‘ H.264 çš„ç¡¬ç¼–ã€ç¡¬è§£</li></ul><hr><span id="more"></span><h3 id="MediaCodec"><a href="#MediaCodec" class="headerlink" title="MediaCodec"></a>MediaCodec</h3><h4 id="MediaCodec-ä»‹ç»"><a href="#MediaCodec-ä»‹ç»" class="headerlink" title="MediaCodec ä»‹ç»"></a>MediaCodec ä»‹ç»</h4><p>MediaCodecç±»å¯ä»¥ç”¨äºä½¿ç”¨ä¸€äº›åŸºæœ¬çš„å¤šåª’ä½“ç¼–è§£ç å™¨ï¼ˆéŸ³è§†é¢‘ç¼–è§£ç ç»„ä»¶ï¼‰ï¼Œå®ƒæ˜¯AndroidåŸºæœ¬çš„å¤šåª’ä½“æ”¯æŒåŸºç¡€æ¶æ„çš„ä¸€éƒ¨åˆ†é€šå¸¸å’Œ<strong>MediaExtractor</strong>ï¼ˆè§£å°è£…éŸ³è§†é¢‘ï¼‰, <strong>MediaSync</strong>ï¼ˆéŸ³è§†é¢‘åŒæ­¥ï¼‰, <strong>MediaMuxer</strong>ï¼ˆå°è£…éŸ³è§†é¢‘ï¼‰, <strong>MediaCrypto</strong>ï¼ˆè§£ç åŠ å¯†çš„åª’ä½“æ•°æ®ï¼‰, <strong>MediaDrm</strong>ï¼ˆè§£å¯†DRMï¼‰, Image, Surface, AudioTrack ä¸€èµ·ä½¿ç”¨ã€‚</p><p>ä¸€ä¸ª<strong>ç¼–è§£ç å™¨</strong>å¯ä»¥<strong>å¤„ç†è¾“å…¥</strong>çš„æ•°æ®æ¥<strong>äº§ç”Ÿè¾“å‡º</strong>çš„æ•°æ®ï¼Œç¼–è§£ç å™¨ä½¿ç”¨<strong>ä¸€ç»„è¾“å…¥å’Œè¾“å‡ºç¼“å†²å™¨</strong>æ¥<strong>å¼‚æ­¥</strong>å¤„ç†æ•°æ®ã€‚ä½ å¯ä»¥<strong>åˆ›å»º</strong>ä¸€ä¸ªç©ºçš„è¾“å…¥ç¼“å†²åŒºï¼Œ<strong>å¡«å……</strong>æ•°æ®å<strong>å‘é€</strong>åˆ°ç¼–è§£ç å™¨è¿›è¡Œå¤„ç†ã€‚ç¼–è§£ç å™¨ä½¿ç”¨è¾“å…¥çš„æ•°æ®è¿›è¡Œ<strong>è½¬æ¢</strong>ï¼Œç„¶å<strong>è¾“å‡º</strong>åˆ°ä¸€ä¸ªç©ºçš„è¾“å‡ºç¼“å†²åŒºã€‚æœ€åä½ <strong>è·å–</strong>åˆ°è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®ï¼Œæ¶ˆè€—æ‰é‡Œé¢çš„æ•°æ®ï¼Œ<strong>é‡Šæ”¾</strong>å›ç¼–è§£ç å™¨ã€‚å¦‚æœåç»­è¿˜æœ‰æ•°æ®éœ€è¦ç»§ç»­å¤„ç†ï¼Œç¼–è§£ç å™¨å°±ä¼šé‡å¤è¿™äº›æ“ä½œã€‚è¾“å‡ºæµç¨‹å¦‚ä¸‹ï¼š</p><img src="/1a455a10/1.webp"><p>ç¼–è§£ç å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼š</p><p>ä¸»è¦çš„ç”Ÿå‘½å‘¨æœŸä¸ºï¼šStoppedã€Executingã€Releasedã€‚</p><ul><li>Stoppedçš„çŠ¶æ€ä¸‹ä¹Ÿåˆ†ä¸ºä¸‰ç§å­çŠ¶æ€ï¼šUninitializedã€Configuredã€Errorã€‚</li><li>Executingçš„çŠ¶æ€ä¸‹ä¹Ÿåˆ†ä¸ºä¸‰ç§å­çŠ¶æ€ï¼šFlushed, Runningã€End-of-Streamã€‚</li></ul><p>ç”Ÿå‘½å‘¨æœŸå›¾ï¼šåŒæ­¥ï¼ˆå·¦ï¼‰ä¸å¼‚æ­¥ï¼ˆå³ï¼‰</p><img src="/1a455a10/2.webp"> <img src="/1a455a10/3.webp"><h4 id="MediaCodec-API-è¯´æ˜"><a href="#MediaCodec-API-è¯´æ˜" class="headerlink" title="MediaCodec API è¯´æ˜"></a>MediaCodec API è¯´æ˜</h4><p>MediaCodecå¯ä»¥å¤„ç†å…·ä½“çš„è§†é¢‘æµï¼Œä¸»è¦æœ‰è¿™å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li>getInputBuffersï¼šè·å–éœ€è¦ç¼–ç æ•°æ®çš„è¾“å…¥æµé˜Ÿåˆ—ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªByteBufferæ•°ç»„</li><li>queueInputBufferï¼šè¾“å…¥æµå…¥é˜Ÿåˆ—</li><li>dequeueInputBufferï¼šä»è¾“å…¥æµé˜Ÿåˆ—ä¸­å–æ•°æ®è¿›è¡Œç¼–ç æ“ä½œ</li><li>getOutputBuffersï¼šè·å–ç¼–è§£ç ä¹‹åçš„æ•°æ®è¾“å‡ºæµé˜Ÿåˆ—ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªByteBufferæ•°ç»„</li><li>dequeueOutputBufferï¼šä»è¾“å‡ºé˜Ÿåˆ—ä¸­å–å‡ºç¼–ç æ“ä½œä¹‹åçš„æ•°æ®</li><li>releaseOutputBufferï¼šå¤„ç†å®Œæˆï¼Œé‡Šæ”¾ByteBufferæ•°æ®</li></ul><h4 id="MediaCodec-æµæ§"><a href="#MediaCodec-æµæ§" class="headerlink" title="MediaCodec æµæ§"></a>MediaCodec æµæ§</h4><p><strong>æµæ§åŸºæœ¬æ¦‚å¿µï¼š</strong></p><p>æµæ§å°±æ˜¯æµé‡æ§åˆ¶ã€‚æ¶‰åŠåˆ°äº† TCP å’Œè§†é¢‘ç¼–ç ï¼šå¯¹ TCP æ¥è¯´å°±æ˜¯æ§åˆ¶å•ä½æ—¶é—´å†…å‘é€æ•°æ®åŒ…çš„æ•°æ®é‡ï¼Œå¯¹ç¼–ç æ¥è¯´å°±æ˜¯æ§åˆ¶å•ä½æ—¶é—´å†…è¾“å‡ºæ•°æ®çš„æ•°æ®é‡ã€‚</p><ul><li>TCP çš„é™åˆ¶æ¡ä»¶æ˜¯ç½‘ç»œå¸¦å®½ï¼Œæµæ§å°±æ˜¯åœ¨é¿å…é€ æˆæˆ–è€…åŠ å‰§ç½‘ç»œæ‹¥å¡çš„å‰æä¸‹ï¼Œå°½å¯èƒ½åˆ©ç”¨ç½‘ç»œå¸¦å®½ã€‚å¸¦å®½å¤Ÿã€ç½‘ç»œå¥½ï¼Œæˆ‘ä»¬å°±åŠ å¿«é€Ÿåº¦å‘é€æ•°æ®åŒ…ï¼Œå‡ºç°äº†å»¶è¿Ÿå¢å¤§ã€ä¸¢åŒ…ä¹‹åï¼Œå°±æ”¾æ…¢å‘åŒ…çš„é€Ÿåº¦ï¼ˆå› ä¸ºç»§ç»­é«˜é€Ÿå‘åŒ…ï¼Œå¯èƒ½ä¼šåŠ å‰§ç½‘ç»œæ‹¥å¡ï¼Œåè€Œå‘å¾—æ›´æ…¢ï¼‰ã€‚<br>è§†é¢‘ç¼–ç çš„é™åˆ¶æ¡ä»¶æœ€åˆæ˜¯è§£ç å™¨çš„èƒ½åŠ›ï¼Œç ç‡å¤ªé«˜å°±ä¼šæ— æ³•è§£ç ï¼Œåæ¥éšç€ codec çš„å‘å±•ï¼Œè§£ç èƒ½åŠ›ä¸å†æ˜¯ç“¶é¢ˆï¼Œé™åˆ¶æ¡ä»¶å˜æˆäº†ä¼ è¾“å¸¦å®½&#x2F;æ–‡ä»¶å¤§å°ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ§åˆ¶æ•°æ®é‡çš„å‰æä¸‹ï¼Œç”»é¢è´¨é‡å°½å¯èƒ½é«˜ã€‚</li><li>æ— è®ºæ˜¯è¦å‘é€çš„ TCP æ•°æ®åŒ…ï¼Œè¿˜æ˜¯è¦ç¼–ç çš„å›¾åƒï¼Œéƒ½å¯èƒ½å‡ºç°â€œå°–å³°â€ï¼Œä¹Ÿå°±æ˜¯çŸ­æ—¶é—´å†…å‡ºç°è¾ƒå¤§çš„æ•°æ®é‡ã€‚TCP é¢å¯¹å°–å³°ï¼Œå¯ä»¥é€‰æ‹©ä¸ä¸ºæ‰€åŠ¨ï¼ˆå°¤å…¶æ˜¯ç½‘ç»œå·²ç»æ‹¥å¡çš„æ—¶å€™ï¼‰ï¼Œè¿™æ²¡æœ‰å¤ªå¤§çš„é—®é¢˜ï¼Œä½†å¦‚æœè§†é¢‘ç¼–ç ä¹Ÿå¯¹å°–å³°ä¸ä¸ºæ‰€åŠ¨ï¼Œé‚£å›¾åƒè´¨é‡å°±ä¼šå¤§æ‰“æŠ˜æ‰£äº†ã€‚å¦‚æœæœ‰å‡ å¸§æ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œä½†ä»è¦æŠŠç ç‡æ§åˆ¶åœ¨åŸæ¥çš„æ°´å¹³ï¼Œé‚£åŠ¿å¿…è¦æŸå¤±æ›´å¤šçš„ä¿¡æ¯ï¼Œå› æ­¤å›¾åƒå¤±çœŸå°±ä¼šæ›´ä¸¥é‡ã€‚</li></ul><p><strong>Android ç¡¬ç¼–ç æµæ§ï¼š</strong></p><p>MediaCodec æµæ§ç›¸å…³çš„æ¥å£å¹¶ä¸å¤šï¼Œä¸€æ˜¯é…ç½®æ—¶è®¾ç½®ç›®æ ‡ç ç‡å’Œç ç‡æ§åˆ¶æ¨¡å¼ï¼ŒäºŒæ˜¯åŠ¨æ€è°ƒæ•´ç›®æ ‡ç ç‡(Android 19 ç‰ˆæœ¬ä»¥ä¸Š)ã€‚</p><p>é…ç½®æ—¶æŒ‡å®šç›®æ ‡ç ç‡å’Œç ç‡æ§åˆ¶æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitRate);</span><br><span class="line">mediaFormat.setInteger(MediaFormat.KEY_BITRATE_MODE, MediaCodecInfo.EncoderCapabilities.BITRATE_MODE_VBR);</span><br><span class="line">mVideoCodec.configure(mediaFormat, <span class="literal">null</span>, <span class="literal">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</span><br></pre></td></tr></table></figure><p>ç ç‡æ§åˆ¶æ¨¡å¼æœ‰ä¸‰ç§ï¼š</p><ul><li>CQ è¡¨ç¤ºå®Œå…¨ä¸æ§åˆ¶ç ç‡ï¼Œå°½æœ€å¤§å¯èƒ½ä¿è¯å›¾åƒè´¨é‡ï¼›</li><li>CBR è¡¨ç¤ºç¼–ç å™¨ä¼šå°½é‡æŠŠè¾“å‡ºç ç‡æ§åˆ¶ä¸ºè®¾å®šå€¼ï¼Œå³æˆ‘ä»¬å‰é¢æåˆ°çš„â€œä¸ä¸ºæ‰€åŠ¨â€ï¼›</li><li>VBR è¡¨ç¤ºç¼–ç å™¨ä¼šæ ¹æ®å›¾åƒå†…å®¹çš„å¤æ‚åº¦ï¼ˆå®é™…ä¸Šæ˜¯å¸§é—´å˜åŒ–é‡çš„å¤§å°ï¼‰æ¥åŠ¨æ€è°ƒæ•´è¾“å‡ºç ç‡ï¼Œå›¾åƒå¤æ‚åˆ™ç ç‡é«˜ï¼Œå›¾åƒç®€å•åˆ™ç ç‡ä½ï¼›</li></ul><p><strong>Android æµæ§ç­–ç•¥é€‰æ‹©ï¼š</strong></p><ul><li>è´¨é‡è¦æ±‚é«˜ã€ä¸åœ¨ä¹å¸¦å®½ã€è§£ç å™¨æ”¯æŒç ç‡å‰§çƒˆæ³¢åŠ¨çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€‰æ‹© CQ ç ç‡æ§åˆ¶ç­–ç•¥ã€‚</li><li>VBR è¾“å‡ºç ç‡ä¼šåœ¨ä¸€å®šèŒƒå›´å†…æ³¢åŠ¨ï¼Œå¯¹äºå°å¹…æ™ƒåŠ¨ï¼Œæ–¹å—æ•ˆåº”ä¼šæœ‰æ‰€æ”¹å–„ï¼Œä½†å¯¹å‰§çƒˆæ™ƒåŠ¨ä»æ— èƒ½ä¸ºåŠ›ï¼›è¿ç»­è°ƒä½ç ç‡åˆ™ä¼šå¯¼è‡´ç ç‡æ€¥å‰§ä¸‹é™ï¼Œå¦‚æœæ— æ³•æ¥å—è¿™ä¸ªé—®é¢˜ï¼Œé‚£ VBR å°±ä¸æ˜¯å¥½çš„é€‰æ‹©ã€‚</li><li>CBR çš„ä¼˜ç‚¹æ˜¯ç¨³å®šå¯æ§ï¼Œè¿™æ ·å¯¹å®æ—¶æ€§çš„ä¿è¯æœ‰å¸®åŠ©ã€‚æ‰€ä»¥ WebRTC å¼€å‘ä¸­ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯CBRã€‚</li></ul><h4 id="MediaCodec-ä½¿ç”¨"><a href="#MediaCodec-ä½¿ç”¨" class="headerlink" title="MediaCodec ä½¿ç”¨"></a>MediaCodec ä½¿ç”¨</h4><p>MediaCodecå¸¸ç”¨æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">createEncoderByTypeï¼ˆ<span class="meta">@NonNul</span> String typeï¼‰ï¼šé™æ€æ„é€ æ–¹æ³•ï¼Œtypeä¸ºæŒ‡å®šçš„éŸ³è§†é¢‘æ ¼å¼ï¼Œåˆ›å»ºæŒ‡å®šæ ¼å¼çš„ç¼–ç å™¨</span><br><span class="line">createDecoderByType(<span class="meta">@NonNull</span> String type)ï¼šé™æ€æ„é€ æ–¹æ³•ï¼Œtypeä¸ºæŒ‡å®šçš„éŸ³è§†é¢‘æ ¼å¼ï¼Œåˆ›å»ºæŒ‡å®šæ ¼å¼çš„è§£ç å™¨</span><br><span class="line">  </span><br><span class="line"><span class="comment">// MediaCodecçš„è®¾ç½®</span></span><br><span class="line">configure(</span><br><span class="line">       <span class="meta">@Nullable</span> MediaFormat format,    <span class="comment">// ç»‘å®šç¼–è§£ç çš„åª’ä½“æ ¼å¼</span></span><br><span class="line">       <span class="meta">@Nullable</span> Surface surface,       <span class="comment">// ç»‘å®šsurfaceï¼Œå¯ä»¥ç›´æ¥å®Œæˆæ•°æ®çš„æ¸²æŸ“</span></span><br><span class="line">       <span class="meta">@Nullable</span> MediaCrypto crypto,    <span class="comment">// åŠ å¯†ç®—æ³•</span></span><br><span class="line">       <span class="meta">@ConfigureFlag</span> <span class="type">int</span> flags)        <span class="comment">// åŠ å¯†çš„æ ¼å¼ï¼Œå¦‚æœä¸éœ€è¦ç›´æ¥è®¾ç½®0å³å¯</span></span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">dequeueInputBuffer</span><span class="params">(<span class="type">long</span> timeoutUs)</span></span><br><span class="line"><span class="comment">// timeoutUsç­‰å¾…æ—¶é—´ï¼Œè¿”å›å¯ä»¥ä½¿ç”¨çš„è¾“å…¥bufferçš„ç´¢å¼•</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// è®¾ç½®æŒ‡å®šç´¢å¼•ä½ç½®çš„bufferçš„ä¿¡æ¯</span></span><br><span class="line">queueInputBuffer(</span><br><span class="line">            <span class="type">int</span> index,          <span class="comment">// æ•°ç»„çš„ç´¢å¼•å€¼</span></span><br><span class="line">            <span class="type">int</span> offset,         <span class="comment">// å†™å…¥bufferçš„èµ·å§‹ä½ç½®</span></span><br><span class="line">            <span class="type">int</span> size,           <span class="comment">// å†™å…¥çš„è¾“å‡ºçš„é•¿åº¦</span></span><br><span class="line">            <span class="type">long</span> presentationTimeUs,    <span class="comment">// è¯¥æ•°æ®æ˜¾ç¤ºçš„æ—¶é—´æˆ³</span></span><br><span class="line">            <span class="type">int</span> flags           <span class="comment">// è¯¥æ•°æ®çš„æ ‡è®°ä½ï¼Œä¾‹å¦‚å…³é”®å¸§ï¼Œç»“æŸå¸§ç­‰ç­‰</span></span><br><span class="line">)</span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">dequeueOutputBuffer</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@NonNull</span> BufferInfo info,  // è¿™ä¸ªBufferInfoéœ€è¦è‡ªå·±æ‰‹åŠ¨åˆ›å»ºï¼Œè°ƒç”¨åï¼Œä¼šæŠŠè¯¥ç´¢å¼•çš„æ•°æ®çš„ä¿¡æ¯å†™åœ¨é‡Œé¢</span></span><br><span class="line"><span class="params">            <span class="type">long</span> timeoutUs             // ç­‰å¾…æ—¶é—´</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line"><span class="comment">// timeoutUsç­‰å¾…æ—¶é—´ï¼Œè¿”å›å¯ä»¥è¯»å–çš„bufferçš„ç´¢å¼•</span></span><br><span class="line">  </span><br><span class="line">releaseOutputBuffer(<span class="type">int</span> index, <span class="type">boolean</span> render)ï¼šé‡Šæ”¾æŒ‡å®šç´¢å¼•ä½ç½®çš„buffer</span><br><span class="line"><span class="comment">// indexï¼šç´¢å¼•</span></span><br><span class="line"><span class="comment">// renderï¼šå¦‚æœç»‘å®šäº†surfaceï¼Œè¯¥æ•°æ®æ˜¯å¦è¦æ¸²æŸ“åˆ°ç”»å¸ƒä¸Š</span></span><br></pre></td></tr></table></figure><p>MediaCodecæ˜¯ç³»ç»Ÿçº§åˆ«çš„ç¼–è§£ç åº“ï¼Œåº•å±‚è¿˜æ˜¯è°ƒç”¨nativeæ–¹æ³•ï¼Œä½¿ç”¨MediaCodecçš„åŸºæœ¬æµç¨‹æ˜¯ï¼š</p><p><strong>åˆ›å»ºä¸æ–‡ä»¶ç›¸åŒ¹é…çš„MediaCodec</strong> -&gt; <strong>MediaCodecå†™å…¥æ•°æ®ï¼Œè¿›è¡Œç¼–ç &#x2F;è§£ç </strong> -&gt; <strong>è¯»å–MediaCodecç¼–&#x2F;è§£ç ç»“æœ</strong></p><p>ã€éŸ³é¢‘MediaCodecçš„å…·ä½“ä½¿ç”¨è¯¦è§éŸ³é¢‘ç¯‡ç¼–è§£ç ã€‘</p><hr><h3 id="MediaExtractor"><a href="#MediaExtractor" class="headerlink" title="MediaExtractor"></a>MediaExtractor</h3><h4 id="MediaExtractor-ä»‹ç»"><a href="#MediaExtractor-ä»‹ç»" class="headerlink" title="MediaExtractor ä»‹ç»"></a>MediaExtractor ä»‹ç»</h4><p>MediaExtractorå­—é¢æ„æ€æ˜¯å¤šåª’ä½“æå–å™¨ï¼Œå®ƒåœ¨Androidçš„éŸ³è§†é¢‘å¼€å‘é‡Œä¸»è¦è´Ÿè´£æå–è§†é¢‘æˆ–è€…éŸ³é¢‘ä¸­çš„ä¿¡æ¯å’Œæ•°æ®æµï¼ˆä¾‹å¦‚å°†è§†é¢‘æ–‡ä»¶ï¼Œè§£æå¤´ä¿¡æ¯ï¼Œå‰¥ç¦»å‡ºéŸ³é¢‘ä¸è§†é¢‘ï¼‰ã€‚</p><h4 id="MediaExtractor-API-è¯´æ˜"><a href="#MediaExtractor-API-è¯´æ˜" class="headerlink" title="MediaExtractor API è¯´æ˜"></a>MediaExtractor API è¯´æ˜</h4><ul><li>setDataSource(String path)ï¼šå³å¯ä»¥è®¾ç½®æœ¬åœ°æ–‡ä»¶åˆå¯ä»¥è®¾ç½®ç½‘ç»œæ–‡ä»¶</li><li>getTrackCount()ï¼šå¾—åˆ°æºæ–‡ä»¶é€šé“æ•°</li><li>getTrackFormat(int index)ï¼šè·å–æŒ‡å®šï¼ˆindexï¼‰çš„é€šé“æ ¼å¼</li><li>getSampleTime()ï¼šè¿”å›å½“å‰çš„æ—¶é—´æˆ³</li><li>readSampleData(ByteBuffer byteBuf, int offset)ï¼šæŠŠæŒ‡å®šé€šé“ä¸­çš„æ•°æ®æŒ‰åç§»é‡è¯»å–åˆ°ByteBufferä¸­ï¼›</li><li>advance()ï¼šè¯»å–ä¸‹ä¸€å¸§æ•°æ®</li><li>release(): è¯»å–ç»“æŸåé‡Šæ”¾èµ„æº</li></ul><h4 id="MediaExtractor-ä½¿ç”¨"><a href="#MediaExtractor-ä½¿ç”¨" class="headerlink" title="MediaExtractor ä½¿ç”¨"></a>MediaExtractor ä½¿ç”¨</h4><ol><li><p>é€šè¿‡setDataSource()è®¾ç½®æ•°æ®æºï¼Œæ•°æ®æºå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯ç½‘ç»œåœ°å€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MediaExtractor</span> <span class="variable">mVideoExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">mVideoExtractor.setDataSource(mVideoPath);</span><br></pre></td></tr></table></figure></li><li><p>å¯ä»¥é€šè¿‡getTrackFormat(int index)æ¥è·å–å„ä¸ªtrackçš„MediaFormatï¼Œé€šè¿‡MediaFormatæ¥è·å–trackçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ï¼šMimeTypeã€åˆ†è¾¨ç‡ã€é‡‡æ ·é¢‘ç‡ã€å¸§ç‡ç­‰ç­‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mVideoExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">    <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mVideoExtractor.getTrackFormat(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MediaFormat: å°è£…æè¿°åª’ä½“æ•°æ®æ ¼å¼çš„ä¿¡æ¯ï¼Œæ— è®ºæ˜¯éŸ³é¢‘è¿˜æ˜¯è§†é¢‘ã€‚åª’ä½“æ•°æ®çš„æ ¼å¼è¢«æŒ‡å®šä¸ºå­—ç¬¦ä¸²/å€¼å¯¹ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ã€è‚¯å®šå¯ä»¥è·å–åˆ°çš„ã€‘</span></span><br><span class="line"><span class="comment">// è·å–MIMEä¿¡æ¯</span></span><br><span class="line"><span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> extractor.getTrackFormat(<span class="number">0</span>);<span class="comment">//è·å–å¤šåª’ä½“æ ¼å¼,å› ä¸ºæ˜¯demoå·²ç»ç¡®å®šè‡ªå·±çš„è§†é¢‘æ–‡ä»¶æ²¡é—®é¢˜,æ‰€ä»¥ç›´æ¥è·å–0ä½è½¨é“</span></span><br><span class="line"><span class="type">String</span> <span class="variable">mimeFormat</span> <span class="operator">=</span> mediaFormat.getString(MediaFormat.KEY_MIME);<span class="comment">//è·å–MIMEæ ¼å¼å†…å®¹</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;mediaExtractor: è·å–MIMEæ ¼å¼å†…å®¹=&quot;</span>+mimeFormat);</span><br><span class="line"><span class="comment">// è·å–è¯­è¨€æ ¼å¼(å¤§å¤šæ•°æƒ…å†µæ˜¯è·å–åˆ°ç©ºçš„å­—ç¬¦ä¸²,ä½†æ˜¯è‡³å°‘ä¸ä¼šæŠ¥null)</span></span><br><span class="line"><span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> extractor.getTrackFormat(<span class="number">0</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">language</span> <span class="operator">=</span> mediaFormat.getString(MediaFormat.KEY_LANGUAGE);<span class="comment">//è·å–è¯­è¨€æ ¼å¼å†…å®¹</span></span><br><span class="line">Log.e(TAG, <span class="string">&quot;mediaExtractor: è·å–è¯­è¨€æ ¼å¼å†…å®¹=&quot;</span>+language);</span><br><span class="line"><span class="comment">// è§†é¢‘çš„é«˜åº¦ä¸å®½åº¦</span></span><br><span class="line"><span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> extractor.getTrackFormat(<span class="number">0</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_WIDTH);<span class="comment">//è·å–é«˜åº¦</span></span><br><span class="line"><span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_HEIGHT);<span class="comment">//è·å–é«˜åº¦</span></span><br><span class="line"><span class="comment">// æ’­æ”¾æ€»æ—¶é•¿</span></span><br><span class="line"><span class="type">long</span> <span class="variable">durationTime</span> <span class="operator">=</span> mediaFormat.getLong(MediaFormat.KEY_DURATION);<span class="comment">//æ€»æ—¶é—´</span></span><br><span class="line"><span class="comment">// è·å–MediaFormatæè¿°çš„æ•°æ®ç¼“å†²åŒºçš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="variable">maxByteCount</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);<span class="comment">//è·å–è§†é¢‘ç¼“å­˜è¾“å‡ºçš„æœ€å¤§å¤§å°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ã€ä¸ä¸€å®šèƒ½è·å–åˆ°ï¼Œæ²¡æœ‰åˆ™ä¼šç©ºæŒ‡é’ˆã€‘</span></span><br><span class="line"><span class="comment">// è·å–é‡‡æ ·ç‡</span></span><br><span class="line"><span class="type">int</span> <span class="variable">sampleRate</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE);<span class="comment">//è·å–é‡‡æ ·ç‡</span></span><br><span class="line"><span class="comment">// è·å–æ¯”ç‰¹ç‡</span></span><br><span class="line"><span class="type">int</span> <span class="variable">bitRate</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_BIT_RATE);<span class="comment">//è·å–æ¯”ç‰¹</span></span><br><span class="line"><span class="comment">// è·å–å£°é“æ•°é‡</span></span><br><span class="line"><span class="type">int</span> <span class="variable">channelCount</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT);<span class="comment">//è·å–å£°é“æ•°é‡</span></span><br><span class="line"><span class="comment">// è·å–æœ€å¤§é«˜åº¦ä¸æœ€å¤§å®½åº¦</span></span><br><span class="line"><span class="type">int</span> <span class="variable">maxWidth</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_MAX_WIDTH);<span class="comment">//æœ€å¤§å®½åº¦</span></span><br><span class="line"><span class="type">int</span> <span class="variable">maxHeight</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_MAX_HEIGHT);<span class="comment">//æœ€å¤§é«˜åº¦</span></span><br><span class="line"><span class="comment">// è·å–é¢œè‰²æ ¼å¼</span></span><br><span class="line"><span class="type">int</span> <span class="variable">colorFormat</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_COLOR_FORMAT);<span class="comment">//é¢œè‰²æ ¼å¼</span></span><br><span class="line"><span class="comment">// è·å–å¸§ç‡</span></span><br><span class="line"><span class="type">int</span> <span class="variable">frameRate</span> <span class="operator">=</span> mediaFormat.getInteger(MediaFormat.KEY_FRAME_RATE);<span class="comment">//å¸§ç‡</span></span><br></pre></td></tr></table></figure></li><li><p>è·å–åˆ°trackçš„è¯¦ç»†ä¿¡æ¯åï¼Œé€šè¿‡selectTrack(int index)é€‰æ‹©æŒ‡å®šçš„é€šé“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;video/&quot;</span>)) &#123;</span><br><span class="line">    mVideoExtractor.selectTrack(i);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šé€šé“ä¹‹åå°±å¯ä»¥ä»MediaExtractorä¸­è¯»å–æ•°æ®äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">sampleSize</span> <span class="operator">=</span> mVideoExtractor.readSampleData(buffer, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    mVideoExtractor.advance(); <span class="comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€å¸§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨è¯»å–ç»“æŸä¹‹åï¼Œè®°å¾—é‡Šæ”¾èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mVideoExtractor.release();</span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="MediaMuxer"><a href="#MediaMuxer" class="headerlink" title="MediaMuxer"></a>MediaMuxer</h3><h4 id="MediaMuxer-ä»‹ç»"><a href="#MediaMuxer-ä»‹ç»" class="headerlink" title="MediaMuxer ä»‹ç»"></a>MediaMuxer ä»‹ç»</h4><p>åˆ©ç”¨MediaExtractoræå–çš„aacå’Œ.h264æ–‡ä»¶ä¸ç»è¿‡å¤„ç†æ²¡åŠæ³•æ’­æ”¾ï¼Œéœ€è¦MediaMuxeråˆå¹¶ç”Ÿæˆå¯ä»¥æ’­æ”¾çš„æ–‡ä»¶ï¼ˆaacæ–‡ä»¶å’Œ.h264éœ€è¦é¦–å…ˆåˆ©ç”¨MediaMuxerç”ŸæˆMP4æ–‡ä»¶ï¼Œæ‰èƒ½è¿›è¡Œåˆå¹¶ï¼‰ã€‚</p><p>MediaMuxerä»api18å¼€å§‹æä¾›ï¼Œå¯ä»¥å°è£…ç¼–ç åçš„è§†é¢‘æµå’ŒéŸ³é¢‘æµåˆ°è§†é¢‘æ–‡ä»¶ä¸­ã€‚ç›®å‰MediaMuxeræ”¯æŒçš„æ–‡ä»¶è¾“å‡ºæ ¼å¼åŒ…æ‹¬MP4ï¼Œwebmå’Œ3gpã€‚</p><img src="/1a455a10/4.webp"><h4 id="MediaMuxer-API-è¯´æ˜"><a href="#MediaMuxer-API-è¯´æ˜" class="headerlink" title="MediaMuxer API è¯´æ˜"></a>MediaMuxer API è¯´æ˜</h4><ul><li>MediaMuxer(String path, int format)</li><li>addTrack(MediaFormat format)ï¼šåˆ©ç”¨MediaFormatæ·»åŠ éŸ³é¢‘æˆ–è§†é¢‘è½¨é“</li><li>release()ï¼šé‡Šæ”¾MediaMuxerçš„èµ„æº</li><li>setLocation(float latitude,float longitude)ï¼šè®¾ç½®å¹¶å­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯åˆ°ç”Ÿæˆæ–‡ä»¶ä¸­</li><li>setOrientationHint(int degrees)ï¼šè®¾ç½®è¾“å‡ºè§†é¢‘å›æ”¾çš„æ–¹å‘æç¤º</li><li>start()ï¼šå¼€å§‹muxerï¼Œç­‰å¾…æ•°æ®çš„è¾“å…¥</li><li>stop()ï¼šåœæ­¢muxerï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°åå°†ç”Ÿæˆåˆæˆçš„æ–‡ä»¶</li><li>writeSampleData(int trackIndex, ByteBuffer byteBuf, MediaCodec.BufferInfo bufferInfo)ï¼šå¾€muxerä¸­å†™å…¥ç¼–ç çš„æ•°æ®ã€‚</li></ul><h4 id="MediaMuxer-ä½¿ç”¨"><a href="#MediaMuxer-ä½¿ç”¨" class="headerlink" title="MediaMuxer ä½¿ç”¨"></a>MediaMuxer ä½¿ç”¨</h4><ol><li><p>ç”ŸæˆMediaMuxerå¯¹è±¡ï¼š</p><p>é€šè¿‡new MediaMuxer(String path, int format)æŒ‡å®šè§†é¢‘æ–‡ä»¶è¾“å‡ºè·¯å¾„å’Œæ–‡ä»¶æ ¼å¼ï¼š<br>MediaMuxer mMediaMuxer &#x3D; new MediaMuxer(mOutputVideoPath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</p></li><li><p>addTrack</p><p>addTrack(MediaFormat format)ï¼Œæ·»åŠ åª’ä½“é€šé“ï¼Œä¼ å…¥MediaFormatå¯¹è±¡ï¼Œé€šå¸¸ä»MediaExtractoræˆ–è€…MediaCodecä¸­è·å–ï¼Œä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»º<br>addTrackä¼šè¿”å›trackindex</p></li><li><p>è°ƒç”¨startå‡½æ•°</p><p>MediaMuxer.start();</p></li><li><p>å†™å…¥æ•°æ®</p><p>è°ƒç”¨MediaMuxer.writeSampleData()å‘mp4æ–‡ä»¶ä¸­å†™å…¥æ•°æ®äº†ã€‚æ¯æ¬¡åªèƒ½æ·»åŠ ä¸€å¸§è§†é¢‘æ•°æ®æˆ–è€…å•ä¸ªSampleçš„éŸ³é¢‘æ•°æ®ï¼Œéœ€è¦BufferInfoå¯¹è±¡ä½œä¸ºå‚æ•°ã€‚<br>BufferInfo info &#x3D; new BufferInfo();<br>info.offset &#x3D; 0;<br>info.size &#x3D; sampleSize;<br>info.flags &#x3D; MediaCodec.BUFFER_FLAG_SYNC_FRAME;<br>info.presentationTimeUs &#x3D; mVideoExtractor.getSampleTime();<br>mMediaMuxer.writeSampleData(videoTrackIndex, buffer, info);<br>info.size å¿…é¡»å¡«å…¥æ•°æ®çš„å¤§å°<br>info.flags éœ€è¦ç»™å‡ºæ˜¯å¦ä¸ºåŒæ­¥å¸§&#x2F;å…³é”®å¸§<br>info.presentationTimeUs å¿…é¡»ç»™å‡ºæ­£ç¡®çš„æ—¶é—´æˆ³ï¼Œæ³¨æ„å•ä½æ˜¯ usï¼Œç¬¬äºŒæ¬¡getSampleTime()å’Œé¦–æ¬¡getSampleTime()çš„æ—¶é—´å·®ã€‚</p></li><li><p>é‡Šæ”¾å…³é—­èµ„æº</p><p>ç»“æŸå†™å…¥åå…³é—­ä»¥åŠé‡Šæ”¾èµ„æºï¼š<br>MediaMuxer.stop();<br>MediaMuxer.release();</p></li></ol><p>å®˜ç½‘say that it is generally used like this:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MediaMuxer</span> <span class="variable">muxer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(<span class="string">&quot;temp.mp4&quot;</span>, OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line"><span class="comment">// More often, the MediaFormat will be retrieved from MediaCodec.getOutputFormat()</span></span><br><span class="line"><span class="comment">// or MediaExtractor.getTrackFormat().</span></span><br><span class="line"><span class="type">MediaFormat</span> <span class="variable">audioFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaFormat</span>(...);</span><br><span class="line"><span class="type">MediaFormat</span> <span class="variable">videoFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaFormat</span>(...);</span><br><span class="line"><span class="type">int</span> <span class="variable">audioTrackIndex</span> <span class="operator">=</span> muxer.addTrack(audioFormat);</span><br><span class="line"><span class="type">int</span> <span class="variable">videoTrackIndex</span> <span class="operator">=</span> muxer.addTrack(videoFormat);</span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(bufferSize);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">finished</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="type">BufferInfo</span> <span class="variable">bufferInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferInfo</span>();</span><br><span class="line"> </span><br><span class="line">muxer.start();</span><br><span class="line"><span class="keyword">while</span>(!finished) &#123;</span><br><span class="line">  <span class="comment">// getInputBuffer() will fill the inputBuffer with one frame of encoded</span></span><br><span class="line">  <span class="comment">// sample from either MediaCodec or MediaExtractor, set isAudioSample to</span></span><br><span class="line">  <span class="comment">// true when the sample is audio data, set up all the fields of bufferInfo,</span></span><br><span class="line">  <span class="comment">// and return true if there are no more samples.</span></span><br><span class="line">  finished = getInputBuffer(inputBuffer, isAudioSample, bufferInfo);</span><br><span class="line">  <span class="keyword">if</span> (!finished) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">currentTrackIndex</span> <span class="operator">=</span> isAudioSample ? audioTrackIndex : videoTrackIndex;</span><br><span class="line">    muxer.writeSampleData(currentTrackIndex, inputBuffer, bufferInfo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">muxer.stop();</span><br><span class="line">muxer.release();</span><br></pre></td></tr></table></figure><hr><h3 id="ç»¼åˆä¾‹å­"><a href="#ç»¼åˆä¾‹å­" class="headerlink" title="ç»¼åˆä¾‹å­"></a>ç»¼åˆä¾‹å­</h3><h4 id="è§†é¢‘æ¢éŸ³"><a href="#è§†é¢‘æ¢éŸ³" class="headerlink" title="è§†é¢‘æ¢éŸ³"></a>è§†é¢‘æ¢éŸ³</h4><p>ä½¿ç”¨MediaExtractorå’ŒMediaMuxeræ¥å®ç°è§†é¢‘çš„æ¢éŸ³</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">muxingAudioAndVideo</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">MediaMuxer</span> <span class="variable">mMediaMuxer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(mOutputVideoPath,</span><br><span class="line">                MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è§†é¢‘çš„MediaExtractor</span></span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">mVideoExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    mVideoExtractor.setDataSource(mVideoPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">videoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mVideoExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mVideoExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;video/&quot;</span>)) &#123;</span><br><span class="line">            mVideoExtractor.selectTrack(i);</span><br><span class="line">            videoTrackIndex = mMediaMuxer.addTrack(format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// éŸ³é¢‘çš„MediaExtractor</span></span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">mAudioExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    mAudioExtractor.setDataSource(mAudioPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">audioTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mAudioExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mAudioExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;audio/&quot;</span>)) &#123;</span><br><span class="line">            mAudioExtractor.selectTrack(i);</span><br><span class="line">            audioTrackIndex = mMediaMuxer.addTrack(format);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// æ·»åŠ å®Œæ‰€æœ‰è½¨é“åstart</span></span><br><span class="line">    mMediaMuxer.start();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// å°è£…è§†é¢‘track</span></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1</span> != videoTrackIndex) &#123;</span><br><span class="line">        MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">        info.presentationTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">100</span> * <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sampleSize</span> <span class="operator">=</span> mVideoExtractor.readSampleData(buffer, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (sampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            info.offset = <span class="number">0</span>;</span><br><span class="line">            info.size = sampleSize;</span><br><span class="line">            info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">            info.presentationTimeUs = mVideoExtractor.getSampleTime();</span><br><span class="line">            mMediaMuxer.writeSampleData(videoTrackIndex, buffer, info);</span><br><span class="line"> </span><br><span class="line">            mVideoExtractor.advance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// å°è£…éŸ³é¢‘track</span></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1</span> != audioTrackIndex) &#123;</span><br><span class="line">        MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">        info.presentationTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">100</span> * <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sampleSize</span> <span class="operator">=</span> mAudioExtractor.readSampleData(buffer, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (sampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            info.offset = <span class="number">0</span>;</span><br><span class="line">            info.size = sampleSize;</span><br><span class="line">            info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">            info.presentationTimeUs = mAudioExtractor.getSampleTime();</span><br><span class="line">            mMediaMuxer.writeSampleData(audioTrackIndex, buffer, info);</span><br><span class="line"> </span><br><span class="line">            mAudioExtractor.advance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// é‡Šæ”¾MediaExtractor</span></span><br><span class="line">    mVideoExtractor.release();</span><br><span class="line">    mAudioExtractor.release();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// é‡Šæ”¾MediaMuxer</span></span><br><span class="line">    mMediaMuxer.stop();</span><br><span class="line">    mMediaMuxer.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¡¬è§£ç h-265è§†é¢‘åŠéŸ³é¢‘è¿›è¡Œæ’­æ”¾"><a href="#ç¡¬è§£ç h-265è§†é¢‘åŠéŸ³é¢‘è¿›è¡Œæ’­æ”¾" class="headerlink" title="ç¡¬è§£ç h.265è§†é¢‘åŠéŸ³é¢‘è¿›è¡Œæ’­æ”¾"></a>ç¡¬è§£ç h.265è§†é¢‘åŠéŸ³é¢‘è¿›è¡Œæ’­æ”¾</h4><p>è§†é¢‘è§£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ã€è®¾ç½®æ•°æ®æºã€‘</span></span><br><span class="line"><span class="type">MediaExtractor</span> <span class="variable">mediaExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    mediaExtractor.setDataSource(path); <span class="comment">// è®¾ç½®æ•°æ®æº</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">    e1.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ã€æ ¹æ®è§†é¢‘çš„ç¼–ç ä¿¡æ¯æ¥åˆå§‹åŒ–MediaCodec: è§†é¢‘çš„mimeTypeæ˜¯videoç±»å‹ã€‚ã€‘</span></span><br><span class="line"><span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mediaExtractor.getTrackCount(); i++) &#123; <span class="comment">// ä¿¡é“æ€»æ•°</span></span><br><span class="line">    <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mediaExtractor.getTrackFormat(i); <span class="comment">// éŸ³é¢‘æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">    mimeType = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">    <span class="keyword">if</span> (mimeType.startsWith(<span class="string">&quot;video/&quot;</span>)) &#123; <span class="comment">// è§†é¢‘ä¿¡é“</span></span><br><span class="line">        mediaExtractor.selectTrack(i); <span class="comment">// åˆ‡æ¢åˆ°è§†é¢‘ä¿¡é“</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mediaCodec = MediaCodec.createDecoderByType(mimeType); <span class="comment">// åˆ›å»ºè§£ç å™¨,æä¾›æ•°æ®è¾“å‡º</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        mediaCodec.configure(format, surface, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mediaCodec.start(); <span class="comment">// å¯åŠ¨MediaCodec ï¼Œç­‰å¾…ä¼ å…¥æ•°æ®</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// ã€è·å–ç¼“å­˜å™¨ã€‘</span></span><br><span class="line"><span class="comment">// è¾“å…¥</span></span><br><span class="line">ByteBuffer[] inputBuffers = mediaCodec.getInputBuffers(); <span class="comment">// ç”¨æ¥å­˜æ”¾ç›®æ ‡æ–‡ä»¶çš„æ•°æ®</span></span><br><span class="line"><span class="comment">// è¾“å‡º</span></span><br><span class="line">ByteBuffer[] outputBuffers = mediaCodec.getOutputBuffers(); <span class="comment">// è§£ç åçš„æ•°æ®</span></span><br><span class="line">MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo(); <span class="comment">// ç”¨äºæè¿°è§£ç å¾—åˆ°çš„byte[]æ•°æ®çš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// ã€å¼€å§‹è§£ç ã€‘</span></span><br><span class="line"><span class="keyword">while</span> (!Thread.interrupted()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!bIsEos) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">inIndex</span> <span class="operator">=</span> mediaCodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (inIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> inputBuffers[inIndex];</span><br><span class="line">            <span class="type">int</span> <span class="variable">nSampleSize</span> <span class="operator">=</span> mediaExtractor.readSampleData(buffer, <span class="number">0</span>); <span class="comment">// è¯»å–ä¸€å¸§æ•°æ®è‡³bufferä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (nSampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;InputBuffer BUFFER_FLAG_END_OF_STREAM&quot;</span>);</span><br><span class="line">                mediaCodec.queueInputBuffer(inIndex, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                bIsEos = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¡«æ•°æ®</span></span><br><span class="line">                mediaCodec.queueInputBuffer(inIndex, <span class="number">0</span>, nSampleSize, mediaExtractor.getSampleTime(), <span class="number">0</span>); <span class="comment">// é€šçŸ¥MediaDecodeè§£ç åˆšåˆšä¼ å…¥çš„æ•°æ®</span></span><br><span class="line">                mediaExtractor.advance(); <span class="comment">// ç»§ç»­ä¸‹ä¸€å–æ ·</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">outIndex</span> <span class="operator">=</span> mediaCodec.dequeueOutputBuffer(info, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">switch</span> (outIndex) &#123;</span><br><span class="line">        <span class="keyword">case</span> MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED:</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;INFO_OUTPUT_BUFFERS_CHANGED&quot;</span>);</span><br><span class="line">            outputBuffers = mediaCodec.getOutputBuffers();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MediaCodec.INFO_OUTPUT_FORMAT_CHANGED:</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;New format &quot;</span> + mediaCodec.getOutputFormat());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MediaCodec.INFO_TRY_AGAIN_LATER:</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;dequeueOutputBuffer timed out!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> outputBuffers[outIndex];</span><br><span class="line">            Log.v(TAG, <span class="string">&quot;We can&#x27;t use this buffer but render it due to the API limit, &quot;</span> + buffer);</span><br><span class="line"> </span><br><span class="line">            mediaCodec.releaseOutputBuffer(outIndex, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((info.flags &amp; MediaCodec.BUFFER_FLAG_END_OF_STREAM) != <span class="number">0</span>) &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;DecodeActivity&quot;</span>, <span class="string">&quot;OutputBuffer BUFFER_FLAG_END_OF_STREAM&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ã€è§£ç å®Œæˆåé‡Šæ”¾èµ„æºã€‘</span></span><br><span class="line">mediaCodec.stop();</span><br><span class="line">mediaCodec.release();</span><br><span class="line">mediaExtractor.release();</span><br></pre></td></tr></table></figure><p>è¿™æ ·è§†é¢‘çš„è§£ç å°±å·²ç»å®Œæˆäº†ï¼Œæ­¤æ—¶surfaceViewå·²ç»å¯ä»¥æ’­æ”¾è§†é¢‘äº†ï¼Œæ¥ä¸‹æ¥æ˜¯éŸ³é¢‘è§£ç ã€‚</p><p>éŸ³é¢‘è§£ç çš„è¿‡ç¨‹å’Œä¸Šé¢å¤§åŒå°å¼‚ï¼Œä¸»è¦åŒºåˆ«åœ¨äºï¼Œè§†é¢‘æ˜¯ç”¨surfaceViewæ’­æ”¾æ˜¾ç¤ºçš„ï¼Œè€ŒéŸ³é¢‘æˆ‘ä»¬éœ€è¦ä½¿ç”¨AudioTrackæ¥æ’­æ”¾ã€‚</p><p>éŸ³é¢‘è§£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ã€åˆ›å»ºä¸€ä¸ªAudioPlayerç±»ç”¨äºæ’­æ”¾éŸ³é¢‘ã€‘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AudioPlayer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mFrequency;<span class="comment">// é‡‡æ ·ç‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mChannel;<span class="comment">// å£°é“</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mSampBit;<span class="comment">// é‡‡æ ·ç²¾åº¦</span></span><br><span class="line">    <span class="keyword">private</span> AudioTrack mAudioTrack;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AudioPlayer</span><span class="params">(<span class="type">int</span> frequency, <span class="type">int</span> channel, <span class="type">int</span> sampbit)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mFrequency = frequency;</span><br><span class="line">        <span class="built_in">this</span>.mChannel = channel;</span><br><span class="line">        <span class="built_in">this</span>.mSampBit = sampbit;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAudioTrack != <span class="literal">null</span>) &#123;</span><br><span class="line">            release();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å¾—æ„å»ºå¯¹è±¡çš„æœ€å°ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">minBufSize</span> <span class="operator">=</span> AudioTrack.getMinBufferSize(mFrequency, mChannel, mSampBit);</span><br><span class="line">        mAudioTrack = <span class="keyword">new</span> <span class="title class_">AudioTrack</span>(AudioManager.STREAM_MUSIC,</span><br><span class="line">                mFrequency, mChannel, mSampBit, minBufSize, AudioTrack.MODE_STREAM);</span><br><span class="line">        mAudioTrack.play();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾èµ„æº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAudioTrack != <span class="literal">null</span>) &#123;</span><br><span class="line">            mAudioTrack.stop();</span><br><span class="line">            mAudioTrack.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†è§£ç åçš„pcmæ•°æ®å†™å…¥audioTrackæ’­æ”¾</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data   æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset åç§»</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length éœ€è¦æ’­æ”¾çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">(<span class="type">byte</span>[] data, <span class="type">int</span> offset, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span> || data.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mAudioTrack.write(data, offset, length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ã€åˆå§‹åŒ–éŸ³é¢‘è§£ç å™¨ï¼šéŸ³é¢‘çš„mineTypeæ˜¯audioç±»å‹ï¼Œæˆ‘ä»¬æ ¹æ®è¿™ä¸ªæ¥å»éŸ³é¢‘ä¿¡æ¯å³å¯ã€‚ã€‘</span></span><br><span class="line">String mimeType;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mediaExtractor.getTrackCount(); i++) &#123; <span class="comment">// ä¿¡é“æ€»æ•°</span></span><br><span class="line">    <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mediaExtractor.getTrackFormat(i); <span class="comment">// éŸ³é¢‘æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">    mimeType = format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">    <span class="keyword">if</span> (mimeType.startsWith(<span class="string">&quot;audio/&quot;</span>)) &#123; <span class="comment">// éŸ³é¢‘ä¿¡é“</span></span><br><span class="line">        mediaExtractor.selectTrack(i); <span class="comment">// åˆ‡æ¢åˆ° éŸ³é¢‘ä¿¡é“</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mediaCodec = MediaCodec.createDecoderByType(mimeType); <span class="comment">// åˆ›å»ºè§£ç å™¨,æä¾›æ•°æ®è¾“å‡º</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        mediaCodec.configure(format, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">        mPlayer = <span class="keyword">new</span> <span class="title class_">AudioPlayer</span>(format.getInteger(MediaFormat.KEY_SAMPLE_RATE), AudioFormat</span><br><span class="line">                .CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT);</span><br><span class="line">        mPlayer.init();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mediaCodec == <span class="literal">null</span>) &#123;</span><br><span class="line">    Log.e(TAG, <span class="string">&quot;Can&#x27;t find video info!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">mediaCodec.start(); <span class="comment">// å¯åŠ¨MediaCodec ï¼Œç­‰å¾…ä¼ å…¥æ•°æ®</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// ã€éŸ³é¢‘è§£ç ï¼šéŸ³é¢‘è§£ç è¿‡ç¨‹ä¸è§†é¢‘è§£ç å¤§åŒå°å¼‚ï¼Œåªéœ€è¦é¢å¤–è°ƒç”¨ä¸€ä¸‹æˆ‘ä»¬åˆ›å»ºçš„AudioPlayeræ¥æ’­æ”¾éŸ³é¢‘å³å¯ã€‚ã€‘</span></span><br><span class="line"><span class="keyword">while</span> (!Thread.interrupted()) &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (!bIsEos) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">inIndex</span> <span class="operator">=</span> mediaCodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (inIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> inputBuffers[inIndex];</span><br><span class="line">            <span class="type">int</span> <span class="variable">nSampleSize</span> <span class="operator">=</span> mediaExtractor.readSampleData(buffer, <span class="number">0</span>); <span class="comment">// è¯»å–ä¸€å¸§æ•°æ®è‡³bufferä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (nSampleSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;InputBuffer BUFFER_FLAG_END_OF_STREAM&quot;</span>);</span><br><span class="line">                mediaCodec.queueInputBuffer(inIndex, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, MediaCodec.BUFFER_FLAG_END_OF_STREAM);</span><br><span class="line">                bIsEos = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å¡«æ•°æ®</span></span><br><span class="line">                mediaCodec.queueInputBuffer(inIndex, <span class="number">0</span>, nSampleSize, mediaExtractor.getSampleTime(), <span class="number">0</span>); <span class="comment">// é€šçŸ¥MediaDecodeè§£ç åˆšåˆšä¼ å…¥çš„æ•°æ®</span></span><br><span class="line">                mediaExtractor.advance(); <span class="comment">// ç»§ç»­ä¸‹ä¸€å–æ ·</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> <span class="variable">outIndex</span> <span class="operator">=</span> mediaCodec.dequeueOutputBuffer(info, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">switch</span> (outIndex) &#123;</span><br><span class="line">        <span class="keyword">case</span> MediaCodec.INFO_OUTPUT_BUFFERS_CHANGED:</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;INFO_OUTPUT_BUFFERS_CHANGED&quot;</span>);</span><br><span class="line">            outputBuffers = mediaCodec.getOutputBuffers();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MediaCodec.INFO_OUTPUT_FORMAT_CHANGED:</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;New format &quot;</span> + mediaCodec.getOutputFormat());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MediaCodec.INFO_TRY_AGAIN_LATER:</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;dequeueOutputBuffer timed out!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> outputBuffers[outIndex];</span><br><span class="line">            Log.v(TAG, <span class="string">&quot;We can&#x27;t use this buffer but render it due to the API limit, &quot;</span> + buffer);</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">while</span> (info.presentationTimeUs / <span class="number">1000</span> &gt; System.currentTimeMillis() - startMs) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sleep(<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ç”¨æ¥ä¿å­˜è§£ç åçš„æ•°æ®</span></span><br><span class="line">            <span class="type">byte</span>[] outData = <span class="keyword">new</span> <span class="title class_">byte</span>[info.size];</span><br><span class="line">            buffer.get(outData);</span><br><span class="line">            <span class="comment">//æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">            buffer.clear();</span><br><span class="line">            <span class="comment">//æ’­æ”¾è§£ç åçš„æ•°æ®</span></span><br><span class="line">            mPlayer.play(outData, <span class="number">0</span>, info.size);</span><br><span class="line">            mediaCodec.releaseOutputBuffer(outIndex, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// All decoded frames have been rendered, we can stop playing</span></span><br><span class="line">    <span class="comment">// now</span></span><br><span class="line">    <span class="keyword">if</span> ((info.flags &amp; MediaCodec.BUFFER_FLAG_END_OF_STREAM) != <span class="number">0</span>) &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;DecodeActivity&quot;</span>, <span class="string">&quot;OutputBuffer BUFFER_FLAG_END_OF_STREAM&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å‚è€ƒä¸é¸£è°¢"><a href="#å‚è€ƒä¸é¸£è°¢" class="headerlink" title="å‚è€ƒä¸é¸£è°¢"></a>å‚è€ƒä¸é¸£è°¢</h3><blockquote><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/renhui/p/7478527.html">https://www.cnblogs.com/renhui/p/7478527.html</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e7eae2541e01">https://www.jianshu.com/p/e7eae2541e01</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/guanxinjing/p/11378133.html">https://www.cnblogs.com/guanxinjing/p/11378133.html</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/66acab100e4b">https://www.jianshu.com/p/66acab100e4b</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_25412055/article/details/78990538">https://blog.csdn.net/qq_25412055/article/details/78990538</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010126792/article/details/86510903">https://blog.csdn.net/u010126792/article/details/86510903</a></p></blockquote></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/a65fdaab.html" rel="prev" title="SFFAI 125 | ç‚¹äº‘è¡¥å…¨ä¸“é¢˜ã€Šå¼ ä¿Šå“²ï¼šShapeInversion: åŸºäºGANé€†æ˜ å°„çš„æ— ç›‘ç£ç‚¹äº‘è¡¥å…¨æ–¹æ³•ã€‹"><i class="fa fa-chevron-left"></i> SFFAI 125 | ç‚¹äº‘è¡¥å…¨ä¸“é¢˜ã€Šå¼ ä¿Šå“²ï¼šShapeInversion: åŸºäºGANé€†æ˜ å°„çš„æ— ç›‘ç£ç‚¹äº‘è¡¥å…¨æ–¹æ³•ã€‹</a></div><div class="post-nav-item"><a href="/9e3298ff.html" rel="next" title="Java-ä¸ºä»€ä¹ˆIntegerçš„1000==1000ä¸ºfalseï¼Œ100==100ä¸ºtrue">Java-ä¸ºä»€ä¹ˆIntegerçš„1000==1000ä¸ºfalseï¼Œ100==100ä¸ºtrue <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener("tabs:register",()=>{let t=CONFIG.comments["activeClass"];var e;(t=CONFIG.comments.storage?localStorage.getItem("comments_active")||t:t)&&(e=document.querySelector(`a[href="#comment-${t}"]`))&&e.click()}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview">ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MediaCodec"><span class="nav-number">2.</span> <span class="nav-text">MediaCodec</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaCodec-%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">MediaCodec ä»‹ç»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaCodec-API-%E8%AF%B4%E6%98%8E"><span class="nav-number">2.2.</span> <span class="nav-text">MediaCodec API è¯´æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaCodec-%E6%B5%81%E6%8E%A7"><span class="nav-number">2.3.</span> <span class="nav-text">MediaCodec æµæ§</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaCodec-%E4%BD%BF%E7%94%A8"><span class="nav-number">2.4.</span> <span class="nav-text">MediaCodec ä½¿ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MediaExtractor"><span class="nav-number">3.</span> <span class="nav-text">MediaExtractor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaExtractor-%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.1.</span> <span class="nav-text">MediaExtractor ä»‹ç»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaExtractor-API-%E8%AF%B4%E6%98%8E"><span class="nav-number">3.2.</span> <span class="nav-text">MediaExtractor API è¯´æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaExtractor-%E4%BD%BF%E7%94%A8"><span class="nav-number">3.3.</span> <span class="nav-text">MediaExtractor ä½¿ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MediaMuxer"><span class="nav-number">4.</span> <span class="nav-text">MediaMuxer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaMuxer-%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">MediaMuxer ä»‹ç»</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaMuxer-API-%E8%AF%B4%E6%98%8E"><span class="nav-number">4.2.</span> <span class="nav-text">MediaMuxer API è¯´æ˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MediaMuxer-%E4%BD%BF%E7%94%A8"><span class="nav-number">4.3.</span> <span class="nav-text">MediaMuxer ä½¿ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E5%90%88%E4%BE%8B%E5%AD%90"><span class="nav-number">5.</span> <span class="nav-text">ç»¼åˆä¾‹å­</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%86%E9%A2%91%E6%8D%A2%E9%9F%B3"><span class="nav-number">5.1.</span> <span class="nav-text">è§†é¢‘æ¢éŸ³</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A1%AC%E8%A7%A3%E7%A0%81h-265%E8%A7%86%E9%A2%91%E5%8F%8A%E9%9F%B3%E9%A2%91%E8%BF%9B%E8%A1%8C%E6%92%AD%E6%94%BE"><span class="nav-number">5.2.</span> <span class="nav-text">ç¡¬è§£ç h.265è§†é¢‘åŠéŸ³é¢‘è¿›è¡Œæ’­æ”¾</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E4%B8%8E%E9%B8%A3%E8%B0%A2"><span class="nav-number">6.</span> <span class="nav-text">å‚è€ƒä¸é¸£è°¢</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Aisaka Aoi" src="/images/manatsu.jpg"><p class="site-author-name" itemprop="name">Aisaka Aoi</p><div class="site-description" itemprop="description">é€¢å‚è‘µçš„ä¸ªäººåšå®¢</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1023</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">20</span> <span class="site-state-item-name">åˆ†ç±»</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/AisakaAoi" title="GitHub ğŸ‘¨â€ğŸ’» â†’ https:&#x2F;&#x2F;github.com&#x2F;AisakaAoi" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub ğŸ‘¨â€ğŸ’»</a> </span><span class="links-of-author-item"><a href="https://github.com/Aisakaorz" title="GitHub ğŸ‘©â€ğŸ’» â†’ https:&#x2F;&#x2F;github.com&#x2F;Aisakaorz" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub ğŸ‘©â€ğŸ’»</a> </span><span class="links-of-author-item"><a href="mailto:aisakaaoi@qq.com" title="E-Mail ğŸ“§ â†’ mailto:aisakaaoi@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail ğŸ“§</a> </span><span class="links-of-author-item"><a href="mailto:chenzongnan@m.scnu.edu.cn" title="E-Mail ğŸ« â†’ mailto:chenzongnan@m.scnu.edu.cn" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail ğŸ«</a> </span><span class="links-of-author-item"><a href="https://space.bilibili.com/91560309" title="Bilibili ğŸ“º â†’ https:&#x2F;&#x2F;space.bilibili.com&#x2F;91560309" rel="noopener" target="_blank"><i class="fab fa-bilibili fa-fw"></i>Bilibili ğŸ“º</a> </span><span class="links-of-author-item"><a href="https://space.bilibili.com/198562921" title="Bilibili ğŸ® â†’ https:&#x2F;&#x2F;space.bilibili.com&#x2F;198562921" rel="noopener" target="_blank"><i class="fab fa-bilibili fa-fw"></i>Bilibili ğŸ®</a> </span><span class="links-of-author-item"><a href="https://www.youtube.com/channel/UCALvyn5Cl76GCotO9pczvjg" title="YouTube ğŸ“º â†’ https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCALvyn5Cl76GCotO9pczvjg" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube ğŸ“º</a></span></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2026</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Aisaka Aoi</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span> <span title="ç«™ç‚¹æ€»å­—æ•°">4m</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span> <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">164:56</span></div><div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>document.querySelectorAll(".pdfobject-container").forEach(e=>{var t=e.dataset.target,a="#"+Object.entries({navpanes:0,toolbar:0,statusbar:0,pagemode:"thumbs",view:"FitH"}).map(([e,t])=>e+"="+encodeURIComponent(t)).join("&"),r="/lib/pdf/web/viewer.html?file="+encodeURIComponent(t)+a;NexT.utils.supportsPDFs()?e.innerHTML=`<embed class="pdfobject" src="${t+a}" type="application/pdf" style="height: ${e.dataset.height};">`:e.innerHTML=`<iframe src="${r}" style="height: ${e.dataset.height};" frameborder="0"></iframe>`})</script><script>NexT.utils.loadComments(document.querySelector("#valine-comments"),()=>{NexT.utils.getScript("//unpkg.com/valine/dist/Valine.min.js",()=>{var i=["nick","mail","link"],e="nick,mail,link".split(",").filter(e=>i.includes(e));new Valine({el:"#valine-comments",verify:!0,notify:!0,appId:"UqjWdRYbIUEUQRXhBUUIh1QE-gzGzoHsz",appKey:"gj89JXC485PFbpdHLKVkz6dm",placeholder:"è¿™é‡Œå¯ä»¥å‘é€è¯„è®º~ï¼ˆä¸Šé¢å¯ä»¥è¾“å…¥æ˜µç§°ã€é‚®ç®±ï¼‰",avatar:"mm",meta:e,pageSize:"10",visitor:!0,lang:"zh-cn",path:location.pathname,recordIP:!1,serverURLs:""})},window.Valine)})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/assets/haru02.model.json"},display:{position:"right",width:208,height:520},mobile:{show:!1},log:!1})</script></body></html>